name: Issue Router - WebSub Publish

on:
  issues:
    types: [opened]

permissions:
  issues: write

concurrency:
  group: issue-router-websub
  cancel-in-progress: false

jobs:
  websub:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Publish WebSub
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GH_PAT != '' && secrets.GH_PAT || github.token }}

          # 必須ではない（未設定ならデフォルトを使う）
          WEBSUB_HUB_URL: ${{ vars.WEBSUB_HUB_URL }}
          WEBSUB_TOPIC_URL: ${{ vars.WEBSUB_TOPIC_URL }}
          PUBLIC_BASE_URL: ${{ vars.PUBLIC_BASE_URL }}

        run: |
          set -euo pipefail
          python websub_publish.py --title "$ISSUE_TITLE" --issue-body "$ISSUE_BODY" --issue-number "$ISSUE_NUMBER" --repo "$REPO"
