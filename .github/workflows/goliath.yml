name: Goliath Auto Tool System

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */8 * * *"

permissions:
  contents: write
  issues: write

concurrency:
  group: goliath-auto
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT != '' && secrets.GH_PAT || github.token }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install openai requests
          fi

      # この run 専用のマーカーを作る
      - name: Prep run markers
        run: |
          mkdir -p goliath/_out
          rm -f goliath/_out/issues_payload_*.json
          touch .run_start

      # main.py は失敗しても workflow を止めない
      - name: Run Goliath System
        continue-on-error: true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LEADS_TOTAL: ${{ vars.LEADS_TOTAL || '100' }}
        run: |
          python main.py || true

      # この run で新しく作られた payload のうち最新1つだけ拾う
      - name: Find payload
        id: find_payload
        run: |
          set -euo pipefail
          f="$(find goliath/_out -maxdepth 1 -type f -name 'issues_payload_*.json' -newer .run_start -printf '%T@ %p\n' \
              | sort -nr | head -n 1 | awk '{print $2}')"
          echo "payload=$f" >> "$GITHUB_OUTPUT"

      # payload から「main.py が確定させた生成サイトURL」だけを Issue に出す
      - name: Create Issue (generated URLs only)
        if: always()
        uses: actions/github-script@v7
        env:
          PAYLOAD_JSON: ${{ steps.find_payload.outputs.payload }}
        with:
          github-token: ${{ secrets.GH_PAT != '' && secrets.GH_PAT || github.token }}
          script: |
            const fs = require('fs');

            const payloadPath = process.env.PAYLOAD_JSON;
            let urls = [];

            if (payloadPath && fs.existsSync(payloadPath)) {
              const data = JSON.parse(fs.readFileSync(payloadPath, 'utf8'));
              const issues = Array.isArray(data.issues) ? data.issues : [];

              for (const it of issues) {
                const body = String(it.body || '');
                // main.py が body の最後に入れた生成サイトURLを拾う
                const found = body.match(/https?:\/\/www\.mikanntool\.com\/[^\s)]+/g) || [];
                urls.push(...found);
              }
            }

            // 重複除去
            urls = [...new Set(urls)];

            let title;
            let body;

            if (urls.length === 0) {
              title = `Goliath run ${context.runId} — no generated URLs`;
              body = `No generated site URLs were found in this run.`;
            } else {
              title = `Goliath generated sites (${urls.length}) — run ${context.runId}`;
              body = urls.join('\n');
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body
            });
