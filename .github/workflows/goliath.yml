name: Goliath Auto Tool System

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */8 * * *"

permissions:
  contents: write
  issues: write

concurrency:
  group: goliath-auto
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT != '' && secrets.GH_PAT || github.token }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install openai requests
          fi

      - name: Ensure state files exist
        run: |
          set -euo pipefail
          mkdir -p state
          if [ ! -f state/last_seen.json ]; then
            cat > state/last_seen.json <<'JSON'
          {
            "x_seen": []
          }
          JSON
          fi
      - name: Prep run markers (avoid reusing old payload)
        run: |
          set -euo pipefail
          mkdir -p goliath/_out
          rm -f goliath/_out/issues_payload_*.json
          touch .run_start

      - name: Run Goliath System (capture exit)
        id: goliath_run
        continue-on-error: true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LEADS_TOTAL: ${{ vars.LEADS_TOTAL || '100' }}

          BSKY_HANDLE: ${{ secrets.BSKY_HANDLE }}
          BSKY_PASSWORD: ${{ secrets.BSKY_PASSWORD }}
          BLUESKY_HANDLE: ${{ secrets.BSKY_HANDLE }}
          BLUESKY_APP_PASSWORD: ${{ secrets.BSKY_PASSWORD }}

          MASTODON_API_BASE: ${{ secrets.MASTODON_API_BASE }}
          MASTODON_ACCESS_TOKEN: ${{ secrets.MASTODON_ACCESS_TOKEN }}
          MASTODON_BASE: ${{ secrets.MASTODON_API_BASE }}
          MASTODON_TOKEN: ${{ secrets.MASTODON_ACCESS_TOKEN }}

          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}

          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}

          X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
          X_USER_ID: ${{ secrets.X_USER_ID }}
          X_QUERY: ${{ vars.X_QUERY }}

          CLICK_LOG_ENDPOINT: ${{ secrets.CLICK_LOG_ENDPOINT }}
          PYTHONUNBUFFERED: "1"
        run: |
          set +e
          python main.py 2>&1 | tee run_log.txt
          realcode=${PIPESTATUS[0]}

          echo "REAL_EXITCODE=$realcode" >> run_log.txt
          echo "exitcode=0" >> "$GITHUB_OUTPUT"
          echo "real_exitcode=$realcode" >> "$GITHUB_OUTPUT"

          exit 0

      - name: Commit and Push Changes (exclude run_log)
        if: always()
        run: |
          set -euo pipefail
          git config user.name "Goliath-Bot"
          git config user.email "bot@mikanntool.com"

          git add -A ":!run_log.txt" || true
          git add -f state/last_seen.json || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Goliath: generate pages + replies + design (auto)"
            git push
          fi

      - name: Upload run log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: goliath-run-log
          path: run_log.txt

      - name: Find issues payload json
        if: always()
        id: find_payload
        run: |
          set -euo pipefail
          f="$(find goliath/_out -maxdepth 1 -type f -name 'issues_payload_*.json' -newer .run_start -printf '%T@ %p\n' 2>/dev/null \
              | sort -nr | head -n 1 | awk '{print $2}')"
          echo "payload=$f" >> "$GITHUB_OUTPUT"
          if [ -z "${f:-}" ]; then
            echo "No NEW issues_payload_*.json created in this run."
          else
            echo "Found NEW payload: $f"
          fi

      - name: Create GitHub Issue from payload
        if: steps.find_payload.outputs.payload != '' && steps.goliath_run.outputs.real_exitcode == '0'

        uses: actions/github-script@v7
        env:
          PAYLOAD_JSON: ${{ steps.find_payload.outputs.payload }}
        with:
          github-token: ${{ secrets.GH_PAT != '' && secrets.GH_PAT || github.token }}
          script: |
            const fs = require('fs');

            const p = process.env.PAYLOAD_JSON;
            if (!p) {
              core.warning('PAYLOAD_JSON is empty. Skip creating issue.');
              return;
            }
            if (!fs.existsSync(p)) {
              core.setFailed(`Payload not found: ${p}`);
              return;
            }

            const data = JSON.parse(fs.readFileSync(p, 'utf8'));
            const runId = data.run_id ?? 'unknown';
            const count = data.count ?? 0;
            const issues = Array.isArray(data.issues) ? data.issues : [];

            if (issues.length === 0) {
              core.warning(`No issues in payload: ${p}`);
              return;
            }

            const title = `Goliath candidates (RUN_ID=${runId}) count=${count}`;
            const body = issues.map(x => `## ${x.title}\n\n${x.body}`).join('\n\n---\n\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body
            });

            core.info(`Created 1 issue from ${p} (parts=${issues.length})`);

