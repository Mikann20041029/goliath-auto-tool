name: Goliath Auto Tool System

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */* * *"

permissions:
  contents: write
  issues: write

concurrency:
  group: goliath-auto
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT != '' && secrets.GH_PAT || github.token }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install openai requests
          fi

      - name: Prep run markers
        run: |
          mkdir -p goliath/_out
          rm -f goliath/_out/issues_payload_*.json
          touch .run_start

      - name: Run Goliath System
        # ここで落ちても次のステップでIssueだけは出す
        continue-on-error: true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LEADS_TOTAL: ${{ vars.LEADS_TOTAL || '100' }}
          SITE_DOMAIN: "https://www.mikanntool.com"
        run: |
          python main.py

      - name: Find payload
        id: find_payload
        run: |
          f="$(find goliath/_out -maxdepth 1 -type f -name 'issues_payload_*.json' -newer .run_start | head -n 1)"
          echo "payload=$f" >> "$GITHUB_OUTPUT"
          echo "Found payload: $f"

      - name: Create Issue (generated URLs only)
        if: always()
        uses: actions/github-script@v7
        env:
          PAYLOAD_JSON: ${{ steps.find_payload.outputs.payload }}
        with:
          github-token: ${{ secrets.GH_PAT != '' && secrets.GH_PAT || github.token }}
          script: |
            const fs = require('fs');

            const payloadPath = process.env.PAYLOAD_JSON;
            let urls = [];

            if (payloadPath && fs.existsSync(payloadPath)) {
              const data = JSON.parse(fs.readFileSync(payloadPath, 'utf8'));
              if (Array.isArray(data.generated_urls)) {
                urls = data.generated_urls.map(String).filter(Boolean);
              }
            }

            // dedup
            urls = [...new Set(urls)];

            let title;
            let body;

            if (urls.length === 0) {
              title = `Goliath run ${context.runId} — no generated URLs`;
              body = `No generated site URLs were found in this run.\n` +
                     `If this is unexpected, check the "Run Goliath System" logs for errors.`;
            } else {
              title = `Goliath generated sites (${urls.length}) — run ${context.runId}`;
              body = urls.join('\n');
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body
            });
